import React, { useEffect, useRef } from 'react';
import { useQuery } from 'react-query';
import { Loader } from '@googlemaps/js-api-loader';

export const BusinessMap = ({ searchParams, onBusinessSelect }) => {
  const mapRef = useRef(null);
  const mapInstance = useRef(null);
  const markers = useRef([]);

  const { data: businesses, isLoading } = useQuery(
    ['businesses', searchParams],
    async () => {
      // Here you would fetch businesses based on searchParams
      return [];
    }
  );

  useEffect(() => {
    const initMap = async () => {
      const loader = new Loader({
        apiKey: process.env.VITE_GOOGLE_MAPS_API_KEY,
        version: 'weekly',
      });

      const google = await loader.load();

      mapInstance.current = new google.maps.Map(mapRef.current, {
        center: { lat: -25.2744, lng: 133.7751 }, // Center of Australia
        zoom: 4,
        styles: [
          {
            featureType: 'administrative',
            elementType: 'labels',
            stylers: [{ visibility: 'on' }]
          },
        ]
      });
    };

    initMap();
  }, []);

  useEffect(() => {
    if (!mapInstance.current || !businesses) return;

    // Clear existing markers
    markers.current.forEach(marker => marker.setMap(null));
    markers.current = [];

    // Add new markers
    businesses.forEach(business => {
      const marker = new google.maps.Marker({
        position: { lat: business.lat, lng: business.lng },
        map: mapInstance.current,
        title: business.name
      });

      marker.addListener('click', () => {
        onBusinessSelect(business);
      });

      markers.current.push(marker);
    });
  }, [businesses, onBusinessSelect]);

  return (
    <div className="flex flex-col h-full">
      {isLoading ? (
        <div className="flex items-center justify-center h-64">
          <p>Loading map...</p>
        </div>
      ) : (
        <div
          ref={mapRef}
          className="w-full h-64 rounded-lg overflow-hidden"
        />
      )}
    </div>
  );
};
